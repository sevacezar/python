# Инструкция по работе со скриптом
___
В данном скрипте реализована логика работы телеграм-бота, перед которым стоит интересная задача: 
подобрать наиболее подходящего для пользователя питомца (а может и несколько).
Ниже вы можете познакомиться со структурой проекта, а также примером работы бота в мобильном приложении Telegram.

## 1. Описание каталогов
- **main.py** - основной скрипт, запуск которого начинает сессию телеграм-бота
- **loader.py** - модуль инициализации глобальных переменных бота и хранилища. Необходим для избежания ошибки обратного импорта
- **.gitignore** - файл с названиями игнорируемых для загрузки в репозиторий файлов и папок
- **.env.template** - шаблон .env файла с переменными окружения. Необходимо заполнить своими данными и удалить из названия ".template"
- **requirements.txt** - файл с основными зависимостями проекта, которые необходимо установить в виртуальное окружение
- **README.MD** - инструкция по работе со скриптом

- **/config_data** - пакет с конфигурационными данными бота
    - **config.py** - модуль конфигурации. Здесь происходит выгрузка переменных окружения,
                    инициализация конфигурационных данных

- **/database** - пакет управления базой данных (БД)
    - **database.py** - модуль управления БД. Хранение данных в БД реализована при помощи ORM - peewee.
    - **pf_database.db** - файл БД

- **/external_services** - пакет взаимодействия с внешними сервисами
    - **pet_finder_api.py** - модуль взаимодействия с API сервиса petfinder.com

- **/handlers** - пакет c обработчиками сообщений
    - **/custom_handlers** - пакет c пользовательскими обработчиками сообщений
        - **find_org.py** - модуль с обработчиками сообщений при выполнении команды /find_org.
                          Результат выполнения команды - страницы с организациями,
                          соответствующие параметрам пользователя
        - **find_pet.py** - модуль с обработчиками сообщений при выполнении команды /find_pet.
                      Результат выполнения команды - страницы с питомцами,
                      соответствующие параметрам пользователя
        - **history.py** - модуль с обработчиками сообщений при выполнении команды /history.
                     Результат выполнения команды - вывод последний запросов пользователя
                     с возможностью их просмотра
    - **/custom_handlers** - пакет cо стандартными обработчиками сообщений
        - **cancel.py** - модуль с обработчиками сообщений при выполнении команды /cancel.
                    Результат выполнения команды - отмена выполняемой команды
        - **help.py** - модуль с обработчиками сообщений при выполнении команды /help.
                  Результат выполнения команды - вывод справки со списком доступных команд
        - **start.py** - модуль с обработчиками сообщений при выполнении команды /start.
                   Результат выполнения команды - вывод приветствия, возможностей бота.

- **/keyboards** - пакет c клавиатурами бота
    - **inline_keyboards.py** - модуль c конструкторами Inline-клавиатур бота
    - **set_menu.py** - модуль c конструктором кнопок меню бота

- **/lexicon** - пакет c текстовыми данными для работы бота
    - **lexicon_ru.py** - модуль c русскоязычными текстовыми данными для работы бота

- **/logs** - пакет логирования при работе бота
    - **/logger.py** - модуль c реализацией функционала логирования при помощи библиотеки loguru
    - **/bot.log** - лог-файл проекта

- **/services** - пакет реализации внутренней логики
    - **/services.py** - модуль c реализацией внутренней логики работы бота. Служит для разгрузки модулей-хэндлеров

- **/states** - пакет с реализацией состояний пользователя (бота)
    - **/user_states.py** - модуль c реализацией состояний пользователя (бота)

- **/utils** - пакет с дополнительным функционалом
    - **/exception.py** - определение основных исключений проекта


## 2. Запуск бота
1. Скопировать проект с репозитория
2. Создать файл .env и заполнить его данными по шаблону .env.template
3. Создать виртуальное окружение
4. Загрузить библиотеки из файла requirements.txt в виртуальное окружение
5. Запустить скрипт main.py
6. Бот готов к запуску

## 3. Возможности бота
1. Как только мы открываем чат с ботом, нас приветствует своей улыбкой очаровательная собака по имени Дейзи. Дейзи половину своей жизни провела в приюте, 
но уже 2 года она живет с семьей и носит гордое звание домашней собаки.
Когда ее хозяева решили обзавестись питомцем, они потратили немало времени, чтобы изучить особенности и характеры подопечных приюта, 
их совместимость с детьми и другими животными, и наконец выбрать для себя идеально подходящего четвероногого друга. 
На тот момент не существовало этого бота, но теперь процесс поиска животного стал легче!
2. При отправке команды */start* бот кратко описывает, для чего он нужен и предлагает отправить команду /help для просмотра 
списка доступного функционала бота
3. Открываем меню бота
4. Отправляем команду */help* для просмотра списка команд

![](/Screens/1-4.png)
5. Отправляем команду */find_pet* для поиска питомца. Бот предлагает ввести город, в котором нужно подыскать пушистого друга
6. Вводим, например, город Tyumen. Бот отправляет предупреждение, что по такому городу информации не найдено...
И это верно. К сожалению, сервис [PetFinder](https://www.petfinder.com/) работает в основном с городами США и Канады. Но
я искренне уверен, что подобный сервис, работающий с российскими приютами, в скором будущем будет реализован
7. Вводим город New York. По данному городу нашлось 3192 результата! Достаточно много, не так ли? Поэтому давайте
отфильтруем результаты. И тут пора определиться, кошатник вы или собачник. Будучи хозяином и кота, и собаки, могу сказать,
что данный выбор - не очень легкий. Но можно сначала присмотреть себе собаку, а потом повторить команду /find_pet и
найти себе кошку :)
8. Итак, мы выбрали собаку, о чем нам просигнализировала кнопка клавиатуры. На следующем шаге бот предлагает выбрать
возрастную категорию бота

![](/Screens/5-8.png)
9. Выбираем, например, "Молодой". Далее необходимо выбрать категорию размера питомца
10. Допустим, "Большой". Можно заметить, что при каждом следующем вопросе бот отправляет кол-во результатов. Так
пользователь наглядно может оценивать, не сильно ли специфичны его требования. Следующий вопрос - есть ли маленькие у
пользователя мальнькие дети. Не все питомцы готовы с распростертыми объятиями встречать маленьких детишек.
11. Далее, бот интересуется, есть ли у нас уже какие-нибудь домашние животные.
Сокращаем в два раза кол-во результатов ответом, что уже есть собака. И переходим к финальному вопросу - есть ли аллергия на шерсть?
При наличии аллергии, бот постарается подобрать питомцев без шерсти. Сразу скажу, что это довольно трудная задача, но решаемая
12. Нажимаем на кнопку "Нет". Следующий шаг - ввод кол-ва результатов для вывода за один раз, но не более 10

![](/Screens/9-12.png)
13. Допустим, хотим видеть 4 результата
14. Далее бот выдает 4 первых результата. Результаты содержат краткую информацию о питомцах с замечательными фото,
мимо которых пройти и остаться равнодушным просто нереально
15. ...
16. Под каждым результатом расположена ссылка на кнопке, перейдя по которой можно получить более детальную информацию о 
питомце

![](/Screens/13-16.png)
17. На следующем шаге бот интересуется, хотим ли мы просмотреть другие результаты. При согласии бот выдает следующие 4
результата
18. Бот будет спрашивать о желании просмотра других результатов до тех пор, пока они не закончатся.
Но мы остановимся и на этом, нажав на кнопку "Нет". Бот сигнализирует о завершении поиска.
19. Теперь давайте посмотрим, как работает команда */find_org*. Данная команда направлена на поиск организаций (приютов),
в которых содержатся питомцы без хозяев. Снова отправляем город. У поиска организаций мало интересных критериев. Однако,
есть возможность сортировать результаты по удаленности от центра города и по имени. Выбираем в порядке возрастания имени.
Вводи кол-во выводимых результатов. Бот начинает отправлять результаты с краткой информацией об организациях.
20. Для получения более подробной информации - под каждым результатом также имеется ссылка на web-страницу

![](/Screens/17-20.png)
21. Далее, отвечаем боту, что не хотим просматривать другие результатами. В конечном итоге бот сигнализирует о завершении
выполнения команды */find_org*
22. Переходим к следующей команде - */history*, позволяющей просматривать историю поисков питомцев и организаций
Стоит упомянуть, что когда пользователь вводит команду */start* - его данные записывают в базу данных. Каждый завершенный 
ненулевым кол-вом результатов поиск питомца или организации попадает в базу данных, из которой затем легко достается эта информация
Собственно, визуализация истории реализована в виде Inline-клавиатуры, где можно видеть дату и время и тип запроса
23. Нажимая на одну из кнопок, бот начинает выводить результаты по этому запросу с возможностью просмотра других страниц 
запроса
24. ...
25. Как обычно, бот интересуется, хотим ли просмотреть другие результаты запроса. При отрицательном ответе бот завершает
выполнение команды. Кроме того, в боте реализована возможность отката. Пользователь может ошибиться или вовсе внезапно
захотеть кардинально изменить параметры поиска. Именно на эти случаи существует команда */cancel*, отменяющая выполнение
задачи
![](/Screens/21-25.png)

